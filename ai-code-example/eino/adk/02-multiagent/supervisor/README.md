# Supervisor多智能体系统

## 1. 系统架构概述

本项目实现了一个基于Eino ADK的多智能体协作系统，采用了监督式架构模式。系统由一个监督智能体（Supervisor Agent）和两个专业子智能体（研究智能体和数学智能体）组成，通过明确的分工与协作完成复杂任务。

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                       用户请求                          │
└─────────────┬───────────────────────────────────────────┘
              │
┌─────────────▼───────────────────────────────────────────┐
│                      Runner组件                         │
└─────────────┬───────────────────────────────────────────┘
              │
┌─────────────▼───────────────────────────────────────────┐
│                   Supervisor Agent                      │
│  ┌────────────────────────────────────────────────────┐ │
│  │  任务分配与协调逻辑                                 │ │
│  └────────────────┬───────────────┬───────────────────┘ │
│                   │               │                     │
│  ┌────────────────▼───┐ ┌─────────▼───────────────┐    │
│  │  Research Agent    │ │  Math Agent             │    │
│  │  ┌──────────────┐  │ │  ┌───────────────────┐  │    │
│  │  │  Search Tool │  │ │  │  Add Tool         │  │    │
│  │  └──────────────┘  │ │  │  Multiply Tool    │  │    │
│  └────────────────────┘ │  │  Divide Tool      │  │    │
│                         │  └───────────────────┘  │    │
│                         └─────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## 2. 核心功能模块说明

### 2.1 监督智能体（Supervisor Agent）

监督智能体是系统的核心协调者，负责：
- 接收用户的复杂查询请求
- 分析请求并分解为子任务
- 选择合适的专业智能体执行子任务
- 协调多个智能体的执行顺序
- 整合子智能体的执行结果
- 向用户返回最终答案

### 2.2 研究智能体（Research Agent）

研究智能体专注于信息检索任务，具备：
- 网络搜索能力
- 信息提取与整理功能
- 严格的任务范围限制（仅处理研究相关任务）

### 2.3 数学智能体（Math Agent）

数学智能体专注于数值计算任务，支持：
- 加法运算
- 乘法运算
- 除法运算
- 精确的数学计算能力

## 3. 主要函数及方法详解

### 3.1 agent.go 核心函数

#### 3.1.1 buildSearchAgent

```go
func buildSearchAgent(ctx context.Context) (adk.Agent, error)
```

**功能**：创建并配置研究智能体

**参数**：
- `ctx`：上下文对象，用于传递执行上下文信息

**返回值**：
- `adk.Agent`：配置完成的研究智能体实例
- `error`：创建过程中可能发生的错误

**关键配置**：
- 名称：`research_agent`
- 描述：负责搜索互联网信息的智能体
- 指令：仅处理研究相关任务，不进行数学计算
- 工具：`search`工具，用于执行网络搜索

#### 3.1.2 buildMathAgent

```go
func buildMathAgent(ctx context.Context) (adk.Agent, error)
```

**功能**：创建并配置数学智能体

**参数**：
- `ctx`：上下文对象，用于传递执行上下文信息

**返回值**：
- `adk.Agent`：配置完成的数学智能体实例
- `error`：创建过程中可能发生的错误

**关键配置**：
- 名称：`math_agent`
- 描述：负责执行数学运算的智能体
- 指令：仅处理数学相关任务
- 工具：`add`、`multiply`、`divide`工具，用于执行基本数学运算

#### 3.1.3 buildSupervisor

```go
func buildSupervisor(ctx context.Context) (adk.Agent, error)
```

**功能**：创建并配置监督智能体，同时初始化子智能体

**参数**：
- `ctx`：上下文对象，用于传递执行上下文信息

**返回值**：
- `adk.Agent`：配置完成的监督智能体实例（包含子智能体）
- `error`：创建过程中可能发生的错误

**执行流程**：
1. 创建监督智能体实例
2. 调用`buildSearchAgent`创建研究智能体
3. 调用`buildMathAgent`创建数学智能体
4. 使用`supervisor.New`将监督智能体与子智能体组合

### 3.2 supervisor.go 核心函数

#### 3.2.1 main

```go
func main()
```

**功能**：程序入口函数，负责初始化系统、执行查询并处理结果

**执行流程**：
1. 创建上下文对象
2. 配置跟踪功能
3. 调用`buildSupervisor`创建监督智能体
4. 定义用户查询：`"find US and New York state GDP in 2024. what % of US GDP was New York state?"`
5. 创建`Runner`实例执行查询
6. 处理并打印执行过程和结果
7. 等待所有跟踪 span 结束

## 4. 完整的调用流程分析

### 4.1 初始化阶段

```
main() → buildSupervisor() → buildSearchAgent() → tools.SafeInferTool()
                          ↓
                          → buildMathAgent() → tools.SafeInferTool() (多次调用)
```

### 4.2 执行阶段

```
main() → adk.NewRunner() → runner.Query() → supervisor.Agent → 研究Agent → search工具
                          ↓                                     ↓
                          → 结果处理与打印 ← 监督Agent ← 结果返回
                                               ↓
                                               → 数学Agent → 数学运算工具
                                               ↓
                                               → 结果返回
```

### 4.3 同步与异步调用关系

- **同步调用**：智能体之间的调用采用同步方式，确保任务按顺序执行
- **工具调用**：智能体内部调用工具时可能采用异步方式，但对外部表现为同步
- **执行顺序**：
  1. 监督智能体首先调用研究智能体获取GDP数据
  2. 研究智能体返回数据后，监督智能体调用数学智能体计算百分比
  3. 数学智能体返回计算结果，监督智能体整合所有信息

## 5. 数据流转路径说明

### 5.1 用户请求处理

```
用户查询 → Runner → 监督智能体 → 子智能体 → 工具 → 子智能体结果 → 监督智能体 → 最终结果 → 用户
```

### 5.2 数据格式转换

- **查询格式**：自然语言文本
- **智能体间通信**：结构化消息格式（包含任务类型、参数等）
- **工具调用**：强类型的请求/响应结构（如searchReq/searchResp、addReq/addResp等）
- **结果返回**：自然语言文本（对用户）或结构化数据（智能体间）

### 5.3 数据依赖关系

- 数学智能体的计算依赖于研究智能体提供的GDP数据
- 监督智能体的决策依赖于子智能体的执行结果
- 用户的最终答案依赖于监督智能体的结果整合

## 6. 关键技术点解析

### 6.1 智能体架构设计

- **分层设计**：监督层、执行层、工具层清晰分离
- **职责单一**：每个智能体专注于自己的专业领域
- **松耦合**：智能体间通过标准化接口通信，便于扩展和替换

### 6.2 工具注册与调用机制

- 使用`tools.SafeInferTool`创建类型安全的工具
- 工具与智能体分离，便于复用和维护
- 支持未知工具处理机制，提高系统健壮性

### 6.3 指令工程

- 为每个智能体提供清晰的角色定义和任务范围
- 严格限制智能体的行为，避免越权操作
- 标准化智能体间的通信格式，提高协作效率

### 6.4 执行流程控制

- 使用`adk.Runner`统一管理查询执行
- 支持流式输出，便于实时监控执行过程
- 集成跟踪功能，便于调试和性能分析

## 7. 系统工作示例

### 7.1 输入查询

```
find US and New York state GDP in 2024. what % of US GDP was New York state?
```

### 7.2 执行步骤

1. **查询解析**：监督智能体分析查询，识别需要先获取GDP数据，再计算百分比
2. **研究阶段**：监督智能体调用研究智能体执行搜索任务
3. **数据获取**：研究智能体使用search工具获取2024年美国和纽约州的GDP数据
4. **计算阶段**：监督智能体调用数学智能体计算纽约州GDP占美国GDP的百分比
5. **结果整合**：监督智能体将研究结果和计算结果整合为最终答案
6. **结果返回**：向用户返回完整答案

### 7.3 预期输出

```
美国2024年GDP为29.18万亿美元，纽约州2024年GDP为2.297万亿美元。纽约州GDP占美国GDP的百分比约为7.87%。
```

## 8. 扩展与优化建议

### 8.1 功能扩展

- 添加更多专业智能体（如数据分析智能体、可视化智能体等）
- 支持智能体间的并行执行，提高复杂任务的处理效率
- 实现任务优先级机制，优化资源分配

### 8.2 性能优化

- 引入缓存机制，减少重复查询和计算
- 优化智能体间的通信协议，降低延迟
- 实现智能体的动态扩展和负载均衡

### 8.3 可靠性提升

- 添加智能体故障检测和自动恢复机制
- 实现任务执行的重试逻辑
- 增强错误处理和日志记录功能
